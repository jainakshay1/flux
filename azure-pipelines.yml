trigger:
- new

pool: default

steps:
- script: ls -ltr
  displayName: 'List files in the working directory'
- task: SonarQubePrepare@6
  inputs:
    SonarQube: 'sonar'
    scannerMode: 'Other'
- task: SonarQubeAnalyze@6
  inputs:
    jdkversion: 'JAVA_HOME_17_X64'
- task: SonarQubePublish@6
  inputs:
    pollingTimeoutSec: '300'

- task: Docker@2
  inputs:
    containerRegistry: 'dockerhub'
    repository: 'akshayasgo/nodetest'
    command: 'buildAndPush'
    Dockerfile: 'testapp/Dockerfile'
    buildContext: 'testapp'
    tags: '$(Build.BuildId)'  # Use the build ID as the tag
  displayName: 'Build and Push Docker Image'

- task: AzureRmWebAppDeployment@4
  inputs:
    ConnectionType: 'AzureRM'
    azureSubscription: 'webapp'
    appType: 'webAppContainer'
    WebAppName: 'kahsyate'
    DockerNamespace: 'docker.io'
    DockerRepository: 'akshayasgo/nodetest'
    DockerImageTag: '$(Build.BuildId)'
  displayName: 'Deploy to Azure Web App'